/**
 * çŒ«çœ¼å½±ç¥¨æŠ¢ç¥¨è„šæœ¬ - é«˜çº§ç‰ˆ
 * @supported Loon 2.1+
 * @version 1.0.0
 */

const $ = API("maoyan-ticket", true); // åˆå§‹åŒ– APIï¼Œå¯ç”¨è°ƒè¯•

// é…ç½®ç®¡ç†
const CONFIG_KEY = "maoyan-config";
const DEFAULT_CONFIG = {
    stockOutRegister: { from: 1, to: 0 },
    ticketStatus: { from: 2, to: 3 },
    saleStatus: { from: 4, to: 3 },
    success: { from: false, to: true },
    remainingStock: { from: 0, to: 2297 },
    showStatus: { from: 2, to: 0 }
};

// åˆå§‹åŒ–é…ç½®
if (!$.read(CONFIG_KEY)) {
    $.write(DEFAULT_CONFIG, CONFIG_KEY);
}

class MaoyanModifier {
    constructor() {
        this.config = $.read(CONFIG_KEY) || DEFAULT_CONFIG;
        this.stats = {
            modifiedCount: 0,
            lastModified: null,
            errorCount: 0
        };
    }

    // å¤„ç†å“åº”
    processResponse(request) {
        const url = request.url;
        const body = $response.body;
        
        $.log(`ğŸ± å¤„ç†è¯·æ±‚: ${url}`);
        
        if (!body) {
            $.error("å“åº”ä½“ä¸ºç©º");
            return { body: body };
        }

        try {
            let data = this.parseJSON(body);
            if (!data) {
                return { body: body };
            }

            const originalData = JSON.stringify(data);
            const modified = this.applyModifications(url, data);

            if (modified) {
                this.stats.modifiedCount++;
                this.stats.lastModified = new Date().toISOString();
                $.write(this.stats, "maoyan-stats");
                
                $.log("âœ… ä¿®æ”¹å®Œæˆ");
                return { body: JSON.stringify(data) };
            } else {
                $.log("â„¹ï¸ æ— éœ€ä¿®æ”¹");
                return { body: body };
            }

        } catch (error) {
            this.stats.errorCount++;
            $.write(this.stats, "maoyan-stats");
            $.error(`å¤„ç†é”™è¯¯: ${error}`);
            return { body: body };
        }
    }

    // è§£æ JSON
    parseJSON(str) {
        try {
            return JSON.parse(str);
        } catch (e) {
            $.error(`JSON è§£æå¤±è´¥: ${e.message}`);
            return null;
        }
    }

    // åº”ç”¨ä¿®æ”¹è§„åˆ™
    applyModifications(url, data) {
        let modified = false;

        // é¡¹ç›®è¯¦æƒ…æ¥å£
        if (url.includes('/my/odea/project/detail')) {
            modified = this.modifyField(data, 'stockOutRegister') || modified;
            modified = this.modifyField(data, 'ticketStatus') || modified;
            modified = this.modifyField(data, 'saleStatus') || modified;
        }
        
        // åº“å­˜éªŒè¯æ¥å£
        else if (url.includes('/my/odea/showTickets/validateStock')) {
            modified = this.modifyField(data, 'success') || modified;
            if (data.error !== null && data.error !== undefined) {
                data.error = null;
                modified = true;
                $.log("âœ… ä¿®æ”¹ error ä¸º null");
            }
        }
        
        // åœºæ¬¡ä¿¡æ¯æ¥å£
        else if (url.includes('/maoyansh/myshow/ajax/channelPage/floorPerfs')) {
            modified = this.modifyField(data, 'remainingStock') || modified;
            modified = this.modifyField(data, 'showStatus') || modified;
        }

        return modified;
    }

    // ä¿®æ”¹å­—æ®µ
    modifyField(data, field) {
        const config = this.config[field];
        if (!config) return false;

        if (data[field] === config.from) {
            data[field] = config.to;
            $.log(`âœ… ä¿®æ”¹ ${field}: ${config.from} â†’ ${config.to}`);
            return true;
        }
        return false;
    }

    // è·å–ç»Ÿè®¡ä¿¡æ¯
    getStats() {
        return $.read("maoyan-stats") || this.stats;
    }

    // é‡ç½®ç»Ÿè®¡
    resetStats() {
        this.stats = {
            modifiedCount: 0,
            lastModified: null,
            errorCount: 0
        };
        $.write(this.stats, "maoyan-stats");
    }
}

// HTTP æœåŠ¡ï¼ˆå¯é€‰ï¼Œç”¨äºç®¡ç†ç•Œé¢ï¼‰
function createService() {
    const $app = express();
    
    $app.get("/stats", (req, res) => {
        const modifier = new MaoyanModifier();
        const stats = modifier.getStats();
        res.json({
            status: "success",
            data: stats
        });
    });

    $app.post("/reset", (req, res) => {
        const modifier = new MaoyanModifier();
        modifier.resetStats();
        res.json({
            status: "success",
            message: "ç»Ÿè®¡å·²é‡ç½®"
        });
    });

    $app.start();
}

// ä¸»å¤„ç†å‡½æ•°
function main() {
    const modifier = new MaoyanModifier();
    const result = modifier.processResponse($request);
    $.done(result);
}

// æ ¹æ®è¯·æ±‚ç±»å‹æ‰§è¡Œä¸åŒé€»è¾‘
if (typeof $request !== "undefined") {
    // è„šæœ¬æ‰§è¡Œæ¨¡å¼
    main();
} else {
    // æœåŠ¡æ¨¡å¼ï¼ˆå¯é€‰ï¼‰
    // createService();
}
